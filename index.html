<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notbetreuung Kita St. Peter K√∂rrenzig</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

<div id="appLock" style="
    position:fixed; inset:0; background:#111;
    display:flex; align-items:center; justify-content:center;
    z-index:9999; color:white;">
  <div style="background:#222;padding:30px;border-radius:12px;text-align:center;">
    <h2>üîê Zugriff gesch√ºtzt</h2>
    <input id="pinField" type="password" maxlength="4"
           style="font-size:24px;text-align:center;padding:10px;">
    <div id="pinError" style="color:#f66;display:none;margin-top:10px;">
      ‚ùå Falsche PIN
    </div>
    <br><br>
    <button onclick="unlockApp()">Entsperren</button>
  </div>
</div>

		
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr 400px;
            gap: 30px;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            grid-column: 1 / -1;
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .status-bar {
            grid-column: 1 / -1;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
        }
        .status-perfect { background: linear-gradient(45deg, #4CAF50, #8BC34A); color: white; }
        .status-warning { background: linear-gradient(45deg, #FF9800, #FFC107); color: white; }
        .settings {
            background: linear-gradient(145deg, #f0f7ff, #e8f0ff);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .settings h2 { color: #333; margin-bottom: 20px; font-size: 1.4em; }
        .fairness-info {
            background: #E3F2FD;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            border-left: 4px solid #2196F3;
        }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .input-group input {
            width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px;
            font-size: 16px; transition: border-color 0.3s;
        }
        .input-group input:focus { outline: none; border-color: #667eea; }
        .save-btn, .reset-btn, .emergency-btn {
            width: 100%; padding: 15px; border: none; border-radius: 10px;
            font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 10px;
            transition: all 0.3s;
        }
        .save-btn { background: linear-gradient(45deg, #4CAF50, #45a049); color: white; }
        .save-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(76,175,80,0.3); }
        .reset-btn { background: linear-gradient(45deg, #f44336, #da190b); color: white; }
        .reset-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(244,67,54,0.3); }
        .emergency-btn { background: linear-gradient(45deg, #ff9800, #f57c00); color: white; }
        .emergency-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255,152,0,0.3); }
        .controls {
            text-align: center; padding: 30px; background: linear-gradient(145deg, #fff8e1, #fff3cd);
            border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        .controls h2 { color: #333; margin-bottom: 20px; font-size: 1.6em; }
        .start-btn, .clear-btn, .copy-btn {
            width: 100%; padding: 18px; border: none; border-radius: 15px;
            font-size: 18px; font-weight: 700; cursor: pointer; margin-bottom: 15px;
            transition: all 0.3s;
        }
        .start-btn {
            background: linear-gradient(45deg, #667eea, #764ba2); color: white; font-size: 22px; height: 70px;
        }
        .start-btn:hover { transform: scale(1.05); box-shadow: 0 20px 40px rgba(102,126,234,0.4); }
        .clear-btn { background: linear-gradient(45deg, #607D8B, #455A64); color: white; }
        .clear-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(96,125,139,0.3); }
        .copy-btn { background: linear-gradient(45deg, #2196F3, #1976D2); color: white; }
        .copy-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(33,150,243,0.3); }
        .desc-text {
            color: #666; font-style: italic; margin: 15px 0; line-height: 1.5;
            background: rgba(255,255,255,0.7); padding: 15px; border-radius: 10px;
        }
        .selected-children {
            background: linear-gradient(145deg, #f3f9ff, #e8f4fd); padding: 30px;
            border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); min-height: 400px;
        }
        .selected-children h2 { 
            text-align: center; color: #333; margin-bottom: 25px; font-size: 1.8em;
            background: linear-gradient(45deg, #4CAF50, #8BC34A); -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stats {
            background: rgba(255,255,255,0.9); padding: 20px; border-radius: 12px; margin-bottom: 20px;
            text-align: center; font-weight: 700; font-size: 18px; color: #333; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .draw-stats {
            background: linear-gradient(45deg, #4CAF50, #8BC34A); color: white; padding: 15px;
            border-radius: 10px; margin-bottom: 20px; text-align: center; font-weight: 700; font-size: 16px;
        }
        .child-item {
            background: white; margin-bottom: 15px; padding: 20px; border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1); transition: all 0.3s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .child-item.new { border-left: 6px solid #4CAF50; background: linear-gradient(90deg, #E8F5E8 0%, white 20px); }
        .child-item.repeat { border-left: 6px solid #FF9800; background: linear-gradient(90deg, #FFF3E0 0%, white 20px); }
        .child-info h4 { font-size: 1.4em; margin-bottom: 8px; color: #333; }
        .child-stats { text-align: right; min-width: 200px; }
        .back-btn {
            background: linear-gradient(45deg, #f44336, #d32f2f); color: white; border: none;
            padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 13px; font-weight: 700;
        }
        .back-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(244,67,54,0.4); }
        .protocol {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef); height: 600px; overflow-y: auto;
            padding: 25px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        .protocol h2 { color: #333; margin-bottom: 20px; font-size: 1.4em; }
        .log-entry {
            background: white; margin-bottom: 12px; padding: 15px; border-radius: 10px;
            border-left: 4px solid #667eea; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .log-time { font-weight: 600; color: #667eea; margin-bottom: 5px; }
        .log-message { color: #333; line-height: 1.4; }
        .pin-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .pin-dialog {
            background: white; padding: 40px; border-radius: 20px; text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3); max-width: 400px; width: 90%;
        }
        .emergency-select { display: none; margin-top: 15px; }
        .emergency-select select {
            width: 100%; padding: 12px; border: 2px solid #ff9800; border-radius: 10px; font-size: 16px;
        }
        @media (max-width: 1200px) {
            .container { grid-template-columns: 1fr; gap: 20px; }
            .start-btn { height: 60px; font-size: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Notbetreuung Kita St. Peter K√∂rrenzig</h1>
            <div class="status-bar status-perfect" id="statusBar">‚úÖ PERFECT FAIR - Jedes Kind gleich oft!</div>
        </div>
        
        <div class="settings">
            <h2>‚öôÔ∏è Einstellungen</h2>
            <div class="fairness-info">
                üéØ <strong>Perfekte Fairness:</strong> Algorithmus garantiert gleiche Ziehungen pro Kind!<br>
                Max. Abweichung: 1 Ziehung zwischen Kindern m√∂glich.
            </div>
            <div class="input-group">
                <label>Gesamtanzahl Kinder:</label>
                <input type="number" id="totalChildren" min="1" value="70">
            </div>
            <div class="input-group">
                <label>Pl√§tze Notbetreuung:</label>
                <input type="number" id="emergencyPlaces" min="1" max="999" value="40">
            </div>
            
            <button class="reset-btn" onclick="showPinDialog()">üîÑ Neues Jahr - Zur√ºcksetzen (PIN 0000)</button>
			<button class="save-btn" onclick="exportBackup()">üíæ Sicherung herunterladen</button>
			<button class="reset-btn" onclick="restoreBackup()">üîÑ Sicherung laden</button>


            <button class="emergency-btn" onclick="toggleEmergency()">üö® Notfall Kind</button>
            <div class="emergency-select" id="emergencySelect">
                <select id="emergencyChildSelect"><option value="">W√§hle Kind...</option></select>
                <button class="save-btn" onclick="addEmergencyChild()" style="margin-top:10px;font-size:14px;">Hinzuf√ºgen</button>
            </div>
        </div>

        <div class="controls">
            <h2>üéØ Faire Zufallsauswahl</h2>
            <div class="stats" id="selectionStats">0 von 40 Kinder gezogen</div>
            <div class="draw-stats" id="drawStats"></div>
            <button class="start-btn" id="startBtn">üé≤ NEUE Ziehung starten</button>
            <div class="desc-text">
                ‚úÖ <strong>Fairness Pr√ºfung</strong> - Erstellt <strong>automatisch ein faires Verh√§ltnis</strong><br>
                üîÑ Kinder mit <strong>weniger Ziehungen</strong> werden garantiert bevorzugt<br>
                üìä <strong>Max. Abweichung: 1</strong> Ziehung zwischen allen Kindern
            </div>
            <button class="clear-btn" onclick="clearCurrentSelection()" id="clearBtn" disabled>üóëÔ∏è Ziehung leeren</button>
            <button class="copy-btn" onclick="copyToClipboard()" id="copyBtn" disabled>üìã Zwischenablage kopieren</button>
        </div>

        <div class="selected-children" id="selectedChildren">
            <h2>üë∂ Heutige Notbetreuung</h2>
            <div id="childrenList"></div>
        </div>

        <div class="protocol">
            <h2>üìã Protokoll</h2>
            <div id="logEntries"></div>
        </div>
    </div>

    <div class="pin-overlay" id="pinOverlay">
        <div class="pin-dialog">
            <h3>üîí Neues Jahr</h3>
            <p>PIN: <code>0000</code></p>
            <input type="password" id="pinInput" maxlength="4" style="font-size:24px;padding:15px;margin:20px 0;border:3px solid #ddd;border-radius:10px;width:120px;text-align:center;font-family:monospace;">
            <br><button class="save-btn" onclick="confirmReset()">‚úÖ Zur√ºcksetzen</button>
            <button class="clear-btn" onclick="hidePinDialog()" style="margin-left:10px;">‚ùå Abbrechen</button>
        </div>
    </div>

<script>
console.log("SCRIPT START");

/* =========================================================
   üîê PIN
========================================================= */
const APP_PIN = "2749";

/* =========================================================
   ‚òÅÔ∏è GITHUB (OPTIONAL)
========================================================= */
const GITHUB_CONFIG = {
    owner: "kitastpeter",
    repo: "Notbetreuung",
    file: "data.json",
    branch: "main",
    token: "__TOKEN_NUR_LOKAL__" // leer lassen oder echten Token
};

/* =========================================================
   üì¶ STATE
========================================================= */
let totalChildren = 70;
let emergencyPlaces = 40;
let childrenData = {};
let currentSelection = [];
let logEntries = [];
let drawCounter = 0;

/* =========================================================
   üîê LOGIN
========================================================= */
function unlockApp() {
    const pin = document.getElementById("pinField").value;
    if (pin === APP_PIN) {
        document.getElementById("appLock").style.display = "none";
        init();
    } else {
        document.getElementById("pinError").style.display = "block";
        document.getElementById("pinField").value = "";
    }
}

/* =========================================================
   ‚òÅÔ∏è CLOUD
========================================================= */
async function loadFromCloud() {
    try {
        const url = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.file}`;
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error();
        Object.assign(window, await r.json());
        return true;
    } catch {
        return false;
    }
}

async function saveToCloud() {
    if (GITHUB_CONFIG.token === "__TOKEN_NUR_LOKAL__") return;

    const content = {
        totalChildren,
        emergencyPlaces,
        childrenData,
        currentSelection,
        logEntries,
        drawCounter,
        updated: new Date().toISOString()
    };

    const api = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.file}`;
    const res = await fetch(api, {
        headers: { Authorization: `Bearer ${GITHUB_CONFIG.token}` }
    });
    const json = await res.json();

    await fetch(api, {
        method: "PUT",
        headers: {
            Authorization: `Bearer ${GITHUB_CONFIG.token}`,
            Accept: "application/vnd.github+json"
        },
        body: JSON.stringify({
            message: "Auto Save",
            content: btoa(JSON.stringify(content, null, 2)),
            sha: json.sha,
            branch: GITHUB_CONFIG.branch
        })
    });
}

/* =========================================================
   üíæ STORAGE
========================================================= */
async function saveToStorage() {
    localStorage.setItem("kita_backup", JSON.stringify({
        totalChildren, emergencyPlaces, childrenData,
        currentSelection, logEntries, drawCounter
    }));
    await saveToCloud();
}

async function loadFromStorage() {
    if (await loadFromCloud()) return;
    const d = localStorage.getItem("kita_backup");
    if (d) Object.assign(window, JSON.parse(d));
}

/* =========================================================
   üöÄ INIT
========================================================= */
async function init() {
    await loadFromStorage();
    ensureChildrenExist();
    loadSettings();
    updateChildSelect();
    renderChildren();
    renderLog();
    updateButtons();
    checkFairness();
    logAction("üöÄ System gestartet");
}

/* =========================================================
   ‚öôÔ∏è SETTINGS
========================================================= */
function ensureChildrenExist() {
    for (let i = 1; i <= totalChildren; i++)
        childrenData[i] ??= { draws: 0, lastDraw: null };
}

function saveSettings() {
    totalChildren = +document.getElementById("totalChildren").value || 70;
    emergencyPlaces = +document.getElementById("emergencyPlaces").value || 40;
    ensureChildrenExist();
    updateChildSelect();
    saveToStorage();
}

function loadSettings() {
    document.getElementById("totalChildren").value = totalChildren;
    document.getElementById("emergencyPlaces").value = emergencyPlaces;
}

/* =========================================================
   üé≤ ZIEHUNG
========================================================= */
function startRandomSelection() {
    ensureChildrenExist();

    drawCounter++;
    currentSelection = [];


const pool = [];
for (let i = 1; i <= totalChildren; i++) {
    if (!childrenData[i]) {
        childrenData[i] = { draws: 0, lastDraw: null };
    }
    pool.push({ id: i, draws: childrenData[i].draws });
}

    logAction(`üé≤ Ziehung #${drawCounter} (${currentSelection.length})`);
    renderChildren();
    updateButtons();
    saveToStorage();
    checkFairness();
}

/* =========================================================
   üìã UI
========================================================= */
function updateChildSelect() {
    const s = document.getElementById("emergencyChildSelect");
    s.innerHTML = `<option value="">Pool...</option>`;
    for (let i = 1; i <= totalChildren; i++)
        if (!currentSelection.includes(i))
            s.innerHTML += `<option value="${i}">Kind ${i}</option>`;
}

function renderChildren() {
    const c = document.getElementById("childrenList");
    c.style.maxHeight = "700px";
    c.style.overflowY = "auto";

    if (!currentSelection.length) {
        c.innerHTML = "üëÜ Ziehung starten";
        return;
    }

    c.innerHTML = currentSelection.map(id =>
        `<div>üë∂ Kind ${id} (${childrenData[id].draws}x)</div>`
    ).join("");
}

function updateButtons() {
    document.getElementById("selectionStats").textContent =
        `${currentSelection.length}/${emergencyPlaces}`;
}

/* =========================================================
   üìú LOG
========================================================= */
function logAction(msg) {
    logEntries.unshift({ time: new Date().toLocaleString(), msg });
    logEntries = logEntries.slice(0, 300);
    renderLog();
}

function renderLog() {
    document.getElementById("logEntries").innerHTML =
        logEntries.map(l => `<div>${l.time} ‚Äì ${l.msg}</div>`).join("");
}

/* =========================================================
   üö® EXTRA
========================================================= */
function toggleEmergency() {
    const e = document.getElementById("emergencySelect");
    e.style.display = e.style.display === "block" ? "none" : "block";
}

function exportBackup() {
    const blob = new Blob(
        [JSON.stringify({ totalChildren, emergencyPlaces, childrenData, logEntries, drawCounter }, null, 2)],
        { type: "application/json" }
    );
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "notbetreuung_backup.json";
    a.click();
}

function restoreBackup() {
    const i = document.createElement("input");
    i.type = "file";
    i.onchange = e => {
        Object.assign(window, JSON.parse(e.target.files[0].text()));
        saveToStorage();
        init();
    };
    i.click();
}

function checkFairness() {
    const d = Object.values(childrenData).map(c => c.draws);
    const min = Math.min(...d), max = Math.max(...d);
    document.getElementById("statusBar").textContent =
        `Fairness: ${min}‚Äì${max}`;
}

window.onload = () => {
    const pin = document.getElementById("pinField");
    if (pin) pin.focus();
};


console.log("SCRIPT ENDE");
</script>

	<input type="file" id="backupFileInput" accept=".txt" style="display:none">
</body>
</html>



