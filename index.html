<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notbetreuung Kita St. Peter K√∂rrenzig</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr 400px;
            gap: 30px;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            grid-column: 1 / -1;
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .status-bar {
            grid-column: 1 / -1;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
        }
        .status-perfect { background: linear-gradient(45deg, #4CAF50, #8BC34A); color: white; }
        .status-warning { background: linear-gradient(45deg, #FF9800, #FFC107); color: white; }
        .settings {
            background: linear-gradient(145deg, #f0f7ff, #e8f0ff);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .settings h2 { color: #333; margin-bottom: 20px; font-size: 1.4em; }
        .fairness-info {
            background: #E3F2FD;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            border-left: 4px solid #2196F3;
        }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .input-group input {
            width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px;
            font-size: 16px; transition: border-color 0.3s;
        }
        .input-group input:focus { outline: none; border-color: #667eea; }
        .save-btn, .reset-btn, .emergency-btn {
            width: 100%; padding: 15px; border: none; border-radius: 10px;
            font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 10px;
            transition: all 0.3s;
        }
        .save-btn { background: linear-gradient(45deg, #4CAF50, #45a049); color: white; }
        .save-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(76,175,80,0.3); }
        .reset-btn { background: linear-gradient(45deg, #f44336, #da190b); color: white; }
        .reset-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(244,67,54,0.3); }
        .emergency-btn { background: linear-gradient(45deg, #ff9800, #f57c00); color: white; }
        .emergency-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255,152,0,0.3); }
        .controls {
            text-align: center; padding: 30px; background: linear-gradient(145deg, #fff8e1, #fff3cd);
            border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        .controls h2 { color: #333; margin-bottom: 20px; font-size: 1.6em; }
        .start-btn, .clear-btn, .copy-btn {
            width: 100%; padding: 18px; border: none; border-radius: 15px;
            font-size: 18px; font-weight: 700; cursor: pointer; margin-bottom: 15px;
            transition: all 0.3s;
        }
        .start-btn {
            background: linear-gradient(45deg, #667eea, #764ba2); color: white; font-size: 22px; height: 70px;
        }
        .start-btn:hover { transform: scale(1.05); box-shadow: 0 20px 40px rgba(102,126,234,0.4); }
        .clear-btn { background: linear-gradient(45deg, #607D8B, #455A64); color: white; }
        .clear-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(96,125,139,0.3); }
        .copy-btn { background: linear-gradient(45deg, #2196F3, #1976D2); color: white; }
        .copy-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(33,150,243,0.3); }
        .desc-text {
            color: #666; font-style: italic; margin: 15px 0; line-height: 1.5;
            background: rgba(255,255,255,0.7); padding: 15px; border-radius: 10px;
        }
        .selected-children {
            background: linear-gradient(145deg, #f3f9ff, #e8f4fd); padding: 30px;
            border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); min-height: 400px;
        }
        .selected-children h2 { 
            text-align: center; color: #333; margin-bottom: 25px; font-size: 1.8em;
            background: linear-gradient(45deg, #4CAF50, #8BC34A); -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stats {
            background: rgba(255,255,255,0.9); padding: 20px; border-radius: 12px; margin-bottom: 20px;
            text-align: center; font-weight: 700; font-size: 18px; color: #333; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .draw-stats {
            background: linear-gradient(45deg, #4CAF50, #8BC34A); color: white; padding: 15px;
            border-radius: 10px; margin-bottom: 20px; text-align: center; font-weight: 700; font-size: 16px;
        }
        .child-item {
            background: white; margin-bottom: 15px; padding: 20px; border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1); transition: all 0.3s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .child-item.new { border-left: 6px solid #4CAF50; background: linear-gradient(90deg, #E8F5E8 0%, white 20px); }
        .child-item.repeat { border-left: 6px solid #FF9800; background: linear-gradient(90deg, #FFF3E0 0%, white 20px); }
        .child-info h4 { font-size: 1.4em; margin-bottom: 8px; color: #333; }
        .child-stats { text-align: right; min-width: 200px; }
        .back-btn {
            background: linear-gradient(45deg, #f44336, #d32f2f); color: white; border: none;
            padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 13px; font-weight: 700;
        }
        .back-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(244,67,54,0.4); }
        .protocol {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef); height: 600px; overflow-y: auto;
            padding: 25px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        .protocol h2 { color: #333; margin-bottom: 20px; font-size: 1.4em; }
        .log-entry {
            background: white; margin-bottom: 12px; padding: 15px; border-radius: 10px;
            border-left: 4px solid #667eea; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .log-time { font-weight: 600; color: #667eea; margin-bottom: 5px; }
        .log-message { color: #333; line-height: 1.4; }
        .pin-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .pin-dialog {
            background: white; padding: 40px; border-radius: 20px; text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3); max-width: 400px; width: 90%;
        }
        .emergency-select { display: none; margin-top: 15px; }
        .emergency-select select {
            width: 100%; padding: 12px; border: 2px solid #ff9800; border-radius: 10px; font-size: 16px;
        }
        @media (max-width: 1200px) {
            .container { grid-template-columns: 1fr; gap: 20px; }
            .start-btn { height: 60px; font-size: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Notbetreuung Kita St. Peter K√∂rrenzig</h1>
            <div class="status-bar status-perfect" id="statusBar">‚úÖ PERFECT FAIR - Jedes Kind gleich oft!</div>
        </div>
        
        <div class="settings">
            <h2>‚öôÔ∏è Einstellungen</h2>
            <div class="fairness-info">
                üéØ <strong>Perfekte Fairness:</strong> Algorithmus garantiert gleiche Ziehungen pro Kind!<br>
                Max. Abweichung: 1 Ziehung zwischen Kindern m√∂glich.
            </div>
            <div class="input-group">
                <label>Gesamtanzahl Kinder:</label>
                <input type="number" id="totalChildren" min="1" value="70">
            </div>
            <div class="input-group">
                <label>Pl√§tze Notbetreuung:</label>
                <input type="number" id="emergencyPlaces" min="1" max="999" value="40">
            </div>
            
            <button class="reset-btn" onclick="showPinDialog()">üîÑ Neues Jahr - Zur√ºcksetzen (PIN 0000)</button>
			<button class="save-btn" onclick="exportBackup()">üíæ Sicherung herunterladen</button>
			<button class="reset-btn" onclick="restoreBackup()">üîÑ Sicherung laden</button>


            <button class="emergency-btn" onclick="toggleEmergency()">üö® Notfall Kind</button>
            <div class="emergency-select" id="emergencySelect">
                <select id="emergencyChildSelect"><option value="">W√§hle Kind...</option></select>
                <button class="save-btn" onclick="addEmergencyChild()" style="margin-top:10px;font-size:14px;">Hinzuf√ºgen</button>
            </div>
        </div>

        <div class="controls">
            <h2>üéØ Faire Zufallsauswahl</h2>
            <div class="stats" id="selectionStats">0 von 40 Kinder gezogen</div>
            <div class="draw-stats" id="drawStats"></div>
            <button class="start-btn" id="startBtn">üé≤ NEUE Ziehung starten</button>
            <div class="desc-text">
                ‚úÖ <strong>Fairness Pr√ºfung</strong> - Erstellt <strong>automatisch ein faires Verh√§ltnis</strong><br>
                üîÑ Kinder mit <strong>weniger Ziehungen</strong> werden garantiert bevorzugt<br>
                üìä <strong>Max. Abweichung: 1</strong> Ziehung zwischen allen Kindern
            </div>
            <button class="clear-btn" onclick="clearCurrentSelection()" id="clearBtn" disabled>üóëÔ∏è Ziehung leeren</button>
            <button class="copy-btn" onclick="copyToClipboard()" id="copyBtn" disabled>üìã Zwischenablage kopieren</button>
        </div>

        <div class="selected-children" id="selectedChildren">
            <h2>üë∂ Heutige Notbetreuung</h2>
            <div id="childrenList"></div>
        </div>

        <div class="protocol">
            <h2>üìã Protokoll</h2>
            <div id="logEntries"></div>
        </div>
    </div>

    <div class="pin-overlay" id="pinOverlay">
        <div class="pin-dialog">
            <h3>üîí Neues Jahr</h3>
            <p>PIN: <code>0000</code></p>
            <input type="password" id="pinInput" maxlength="4" style="font-size:24px;padding:15px;margin:20px 0;border:3px solid #ddd;border-radius:10px;width:120px;text-align:center;font-family:monospace;">
            <br><button class="save-btn" onclick="confirmReset()">‚úÖ Zur√ºcksetzen</button>
            <button class="clear-btn" onclick="hidePinDialog()" style="margin-left:10px;">‚ùå Abbrechen</button>
        </div>
    </div>

    <script>
        let totalChildren = 70, emergencyPlaces = 40, childrenData = {}, currentSelection = [], 
            logEntries = [], drawCounter = 0;

     /* =========================================================
   üîê PIN SCHUTZ
========================================================= */
const APP_PIN = "2749"; // <-- PIN hier √§ndern

/* =========================================================
   ‚òÅÔ∏è GITHUB CLOUD KONFIGURATION (PLATZHALTER)
========================================================= */
const GITHUB_CONFIG = {
    owner: "kitastpeter",                     // <-- GitHub Name
    repo: "Notbetreuung",                // <-- Repo Name
    file: "data.json",
    branch: "main",
    token: "github_pat"      // <-- PLATZHALTER
};

/* =========================================================
   üì¶ GLOBALE DATEN
========================================================= */
let totalChildren = 70;
let emergencyPlaces = 40;
let childrenData = {};
let currentSelection = [];
let logEntries = [];
let drawCounter = 0;

/* =========================================================
   üîê APP ENTSPERREN
========================================================= */
function unlockApp() {
    const input = document.getElementById("pinField").value;
    if (input === APP_PIN) {
        document.getElementById("appLock").style.display = "none";
        init();
    } else {
        document.getElementById("pinError").style.display = "block";
        document.getElementById("pinField").value = "";
    }
}

/* =========================================================
   ‚òÅÔ∏è CLOUD LADEN
========================================================= */
async function loadFromCloud() {
    try {
        const url = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.file}`;
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error();

        const data = await res.json();
        ({
            childrenData,
            currentSelection,
            logEntries,
            drawCounter,
            totalChildren,
            emergencyPlaces
        } = data);

        return true;
    } catch (e) {
        console.warn("Cloud nicht erreichbar ‚Äì nutze lokal");
        return false;
    }
}

/* =========================================================
   ‚òÅÔ∏è CLOUD SPEICHERN
========================================================= */
async function saveToCloud() {
    if (GITHUB_CONFIG.token === "github_pat") return;

    const content = {
        childrenData,
        currentSelection,
        logEntries,
        drawCounter,
        totalChildren,
        emergencyPlaces,
        lastUpdate: new Date().toISOString()
    };

    const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.file}`;

    const res = await fetch(apiUrl, {
        headers: {
            Authorization: `Bearer ${GITHUB_CONFIG.token}`,
            Accept: "application/vnd.github+json"
        }
    });

    const json = await res.json();

    await fetch(apiUrl, {
        method: "PUT",
        headers: {
            Authorization: `Bearer ${GITHUB_CONFIG.token}`,
            Accept: "application/vnd.github+json"
        },
        body: JSON.stringify({
            message: "Auto-Save Notbetreuung",
            content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
            sha: json.sha,
            branch: GITHUB_CONFIG.branch
        })
    });
}

/* =========================================================
   üíæ LOKAL + CLOUD KOMBINIERT
========================================================= */
async function saveToStorage() {
    localStorage.setItem("kita_backup", JSON.stringify({
        childrenData,
        currentSelection,
        logEntries,
        drawCounter,
        totalChildren,
        emergencyPlaces
    }));
    await saveToCloud();
}

async function loadFromStorage() {
    if (await loadFromCloud()) return;

    const local = localStorage.getItem("kita_backup");
    if (local) {
        ({
            childrenData,
            currentSelection,
            logEntries,
            drawCounter,
            totalChildren,
            emergencyPlaces
        } = JSON.parse(local));
    }
}
			
        function init() {
            loadFromStorage() || (ensureChildrenExist(), saveToStorage());
            updateChildSelect(); renderChildren(); renderLog(); loadSettings(); updateButtons();
            logAction('üöÄ Fairness-Algorithmus v3.0 aktiv');
            checkFairness();
        }

        function ensureChildrenExist() {
            for(let i=1; i<=totalChildren; i++) childrenData[i] = {draws:0, lastDraw:null};
        }

        function saveSettings() {
            totalChildren = +document.getElementById('totalChildren').value || 70;
            emergencyPlaces = +document.getElementById('emergencyPlaces').value || 40;
            ensureChildrenExist(); updateChildSelect(); saveToStorage(); renderChildren();
            logAction(`‚öôÔ∏è ${totalChildren} Kinder, ${emergencyPlaces} Pl√§tze`);
        }

        function loadSettings() {
            document.getElementById('totalChildren').value = totalChildren;
            document.getElementById('emergencyPlaces').value = emergencyPlaces;
        }

        function updateChildSelect() {
            const s = document.getElementById('emergencyChildSelect');
            s.innerHTML = '<option value="">Pool...</option>';
            for(let i=1; i<=totalChildren; i++) if(!currentSelection.includes(i)) {
                s.innerHTML += `<option value="${i}">Kind ${i} (${childrenData[i].draws}x)</option>`;
            }
        }

        function logAction(msg) {
            logEntries.unshift({time: new Date().toLocaleString('de-DE'), message: msg});
            logEntries.length = Math.min(500, logEntries.length);
            renderLog(); saveToStorage();
        }

        function renderLog() {
            document.getElementById('logEntries').innerHTML = logEntries.slice(0,50)
                .map(e => `<div class="log-entry"><div class="log-time">${e.time}</div><div class="log-message">${e.message}</div></div>`).join('');
        }

        function updateButtons() {
            document.getElementById('clearBtn').disabled = !currentSelection.length;
            document.getElementById('copyBtn').disabled = !currentSelection.length;
            document.getElementById('selectionStats').textContent = `${currentSelection.length} von ${emergencyPlaces}`;
        }

        // üéØ PERFEKTER FAIRNESS-ALGORITHMUS
        function startRandomSelection() {
    drawCounter++;
    currentSelection = [];

    // Pool aller Kinder mit Ziehungsanzahl
    const pool = [];
    for (let i = 1; i <= totalChildren; i++) {
        pool.push({ id: i, draws: childrenData[i].draws });
    }

    // Sortierung: erst wenigste Ziehungen, dann Zufall
    pool.sort((a, b) => {
        if (a.draws !== b.draws) return a.draws - b.draws;
        return Math.random() - 0.5;
    });

    // üîí ZWINGEND exakt emergencyPlaces Kinder
    const selected = pool.slice(0, emergencyPlaces);

    selected.forEach(kid => {
        currentSelection.push(kid.id);
        childrenData[kid.id].draws++;
        childrenData[kid.id].lastDraw = new Date().toISOString();
    });

    const minDraws = selected[0]?.draws ?? 0;
    const maxDraws = Math.max(...selected.map(k => childrenData[k.id].draws));
    const newKids = selected.filter(k => childrenData[k.id].draws === 1).length;

    logAction(`üé≤ #${drawCounter}: ${currentSelection.length}/${emergencyPlaces} (${newKids} neu) - Fairness ${minDraws}x`);
    document.getElementById('drawStats').innerHTML =
        `üìä Ziehung #${drawCounter}<br>Aktueller Unterschied Min: ${minDraws}x zu Max: ${maxDraws}x`;

    updateChildSelect();
    renderChildren();
    saveToStorage();
    updateButtons();
    checkFairness();
}

            

        

        document.getElementById('startBtn').onclick = startRandomSelection;

        function clearCurrentSelection() {
            logAction(`üóëÔ∏è Ziehung #${drawCounter} geleert`);
            currentSelection = []; document.getElementById('drawStats').innerHTML = ''; 
            renderChildren(); saveToStorage(); updateButtons();
        }

function renderChildren() {
    const c = document.getElementById('childrenList');

    // üîΩ Scrollbar direkt per JS
    c.style.maxHeight = '700px';
    c.style.overflowY = 'auto';
    c.style.paddingRight = '10px';

    if (!currentSelection.length) {
        c.innerHTML =
            '<div style="text-align:center;color:#999;padding:60px;font-size:18px;">üëÜ "Zufallsauswahl starten" f√ºr faire Ziehung!</div>';
        return;
    }

    c.innerHTML = currentSelection.map(id => {
        const d = childrenData[id];
        const isNew = d.draws === 1;
        return `
        <div class="child-item ${isNew ? 'new' : 'repeat'}">
            <div class="child-info">
                <h4>üë∂ Kind ${id}</h4>
                <div><strong>${isNew ? 'ü•≥ NEU' : 'üîÑ ' + d.draws + 'x'}</strong></div>
            </div>
            <div class="child-stats">
                <button class="back-btn" onclick="returnChild(${id})">‚ùå Nicht ben√∂tigt</button>
            </div>
        </div>`;
    }).join('');
}


        window.returnChild = function(childId) {
            const idx = currentSelection.indexOf(childId);
            if(idx === -1) return;
            childrenData[childId].draws = Math.max(0, childrenData[childId].draws - 1);
            currentSelection.splice(idx, 1);
            
            // Faire Nachf√ºllung
            const candidates = [];
            for(let i=1; i<=totalChildren; i++) if(!currentSelection.includes(i)) {
                candidates.push({id:i, draws:childrenData[i].draws});
            }
            if(candidates.length) {
                candidates.sort((a,b) => a.draws - b.draws);
                const rep = candidates[0].id;
                currentSelection.push(rep); childrenData[rep].draws++;
                logAction(`üîÑ ${childId} ‚Üí ${rep}`);
            } else logAction(`‚ö†Ô∏è ${childId} entfernt`);
            
            updateChildSelect(); renderChildren(); saveToStorage();
        }

        function copyToClipboard() {
            const text = currentSelection.map(id => `Kind ${id}`).join('\n');
            navigator.clipboard?.writeText(text)?.then(feedbackCopy) || (() => {
                const ta = document.createElement('textarea');
                ta.value = text; document.body.appendChild(ta); ta.select(); 
                document.execCommand('copy'); document.body.removeChild(ta); feedbackCopy();
            })();
        }

        function feedbackCopy() {
            logAction(`üìã ${currentSelection.length} Kinder (#${drawCounter})`);
            const btn = document.getElementById('copyBtn'), old = btn.textContent;
            btn.textContent = `‚úÖ Kopiert! (${currentSelection.length})`;
            setTimeout(()=>btn.textContent=old, 2000);
        }

        function toggleEmergency() {
            const d = document.getElementById('emergencySelect');
            d.style.display = d.style.display === 'block' ? 'none' : 'block';
        }

        function addEmergencyChild() {
            const id = +document.getElementById('emergencyChildSelect').value;
            if(id && !currentSelection.includes(id)) {
                currentSelection.push(id); childrenData[id].draws++;
                logAction(`üö® Notfall: ${id}`);
                updateChildSelect(); renderChildren(); saveToStorage();
                document.getElementById('emergencySelect').style.display = 'none';
            }
        }

        function checkFairness() {
            const draws = Object.values(childrenData).map(c => c.draws);
            const minD = Math.min(...draws), maxD = Math.max(...draws);
            const status = document.getElementById('statusBar');
            status.textContent = `‚úÖ Fairness perfekt: ${minD}-${maxD}x (${maxD-minD <= 1 ? 'PERFEKT' : 'Warnung'})`;
            status.className = `status-bar ${maxD - minD <= 1 ? 'status-perfect' : 'status-warning'}`;
        }

        function showPinDialog() { document.getElementById('pinOverlay').style.display = 'flex'; }
        function hidePinDialog() { document.getElementById('pinOverlay').style.display = 'none'; }
        function confirmReset() {
            if(document.getElementById('pinInput').value === '0000') {
                for(let i=1; i<=totalChildren; i++) childrenData[i] = {draws:0, lastDraw:null};
                currentSelection = []; drawCounter = 0;
                logAction('üéØ NEUES JAHR - Perfect Reset');
                renderChildren(); saveToStorage(); hidePinDialog(); checkFairness();
            } else {
                alert('‚ùå PIN 0000'); document.getElementById('pinInput').value = '';
            }
        }

        document.getElementById('pinInput').addEventListener('keypress', e => e.key==='Enter' && confirmReset());
        document.getElementById('totalChildren').addEventListener('change', saveSettings);
        document.getElementById('emergencyPlaces').addEventListener('change', saveSettings);

        window.addEventListener("load", () => {
    document.getElementById("pinField").focus();
});

		
		function exportBackup() {
    const backup = {
        meta: {
            app: "Notbetreuung Kita St. Peter K√∂rrenzig",
            created: new Date().toISOString(),
            version: "3.1"
        },
        state: {
            totalChildren,
            emergencyPlaces,
            drawCounter,
            childrenData,
            logEntries
        }
    };

    const blob = new Blob(
        [JSON.stringify(backup, null, 2)],
        { type: "text/plain;charset=utf-8" }
    );

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `notbetreuung_sicherung_${new Date().toISOString().slice(0,10)}.txt`;
    a.click();

    logAction("üíæ Sicherung exportiert");
}

		function restoreBackup() {
    const input = document.getElementById("backupFileInput");
    input.click();

    input.onchange = () => {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = e => {
            try {
                const data = JSON.parse(e.target.result);

                if (!data.state || !data.meta) {
                    alert("‚ùå Ung√ºltige Sicherungsdatei");
                    return;
                }

                ({ totalChildren, emergencyPlaces, drawCounter, childrenData, logEntries } = data.state);

                currentSelection = [];
                saveToStorage();
                loadSettings();
                updateChildSelect();
                renderChildren();
                renderLog();
                checkFairness();

                logAction("üîÑ Sicherung wiederhergestellt");
                alert("‚úÖ Sicherung erfolgreich geladen");
            } catch {
                alert("‚ùå Datei konnte nicht gelesen werden");
            }
        };
        reader.readAsText(file);
    };
}

		
    </script>
	<input type="file" id="backupFileInput" accept=".txt" style="display:none">
</body>
</html>

